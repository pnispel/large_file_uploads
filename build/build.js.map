{"version":3,"sources":["node_modules/browserify/node_modules/browser-pack/_prelude.js","lib/promise.js","src/index.js","src/indexeddb.js"],"names":[],"mappings":"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","file":"build.js","sourceRoot":"/source/","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","// (c) copyright unscriptable.com / John Hann\n// License MIT\n// For more robust promises, see https://github.com/briancavalier/when.js.\n\nfunction Promise () {\n  this._thens = [];\n}\n\nPromise.all = function (promises) {\n  var p = new Promise();\n  var size = promises.length;\n  var returned = 0;\n  var returns = [];\n\n  promises.forEach(function (promise) {\n    promise.then((function (promise) {\n      return function () {\n        returned++;\n\n        returns.push(arguments);\n\n        if (returned === size) {\n          p.resolve(returns);\n        }\n      }\n    })(promise));\n  });\n\n  setTimeout((function (size) {\n    return function () {\n      if (size === 0) {\n        p.resolve();\n      }\n    }\n  })(size));\n\n  return p;\n};\n\nPromise.prototype = {\n\n  /* This is the \"front end\" API. */\n\n  // then(onResolve, onReject): Code waiting for this promise uses the\n  // then() method to be notified when the promise is complete. There\n  // are two completion callbacks: onReject and onResolve. A more\n  // robust promise implementation will also have an onProgress handler.\n  then: function (onResolve, onReject) {\n    // capture calls to then()\n    this._thens.push({ resolve: onResolve, reject: onReject });\n  },\n\n  // Some promise implementations also have a cancel() front end API that\n  // calls all of the onReject() callbacks (aka a \"cancelable promise\").\n  // cancel: function (reason) {},\n\n  /* This is the \"back end\" API. */\n\n  // resolve(resolvedValue): The resolve() method is called when a promise\n  // is resolved (duh). The resolved value (if any) is passed by the resolver\n  // to this method. All waiting onResolve callbacks are called\n  // and any future ones are, too, each being passed the resolved value.\n  resolve: function (val) { this._complete('resolve', val); },\n\n  // reject(exception): The reject() method is called when a promise cannot\n  // be resolved. Typically, you'd pass an exception as the single parameter,\n  // but any other argument, including none at all, is acceptable.\n  // All waiting and all future onReject callbacks are called when reject()\n  // is called and are passed the exception parameter.\n  reject: function (ex) { this._complete('reject', ex); },\n\n  // Some promises may have a progress handler. The back end API to signal a\n  // progress \"event\" has a single parameter. The contents of this parameter\n  // could be just about anything and is specific to your implementation.\n  // progress: function (data) {},\n\n  /* \"Private\" methods. */\n\n  _complete: function (which, arg) {\n    // switch over to sync then()\n    this.then = which === 'resolve' ?\n      function (resolve, reject) { resolve && resolve(arg); } :\n      function (resolve, reject) { reject && reject(arg); };\n    // disallow multiple calls to resolve or reject\n    this.resolve = this.reject =\n      function () { throw new Error('Promise already completed.'); };\n    // complete all waiting (async) then()s\n    var aThen, i = 0;\n    while (aThen = this._thens[i++]) { aThen[which] && aThen[which](arg); }\n    delete this._thens;\n  }\n\n};\n\nexport default Promise;\n","import Promise from \"../lib/promise\";\nimport IDB from \"./indexeddb\";\n\n/* -------------------------------------------------------------------------- */\n\nconst Cache = {\n  /**\n   * set a cache item in indexeddb\n   *\n   * @param {String} key - a unique identifier for this blob\n   * @param {Blob} blob - the blob of data to be inserted\n   * @param {Integer} minutes_to_removal - time until removal from cache\n   */\n  set (key, blob, minutes_to_removal=60) {\n    let now = Date.now();\n    let millisecondsToRemoval = minutes_to_removal * 60 * 1000;\n\n    IDB.addLedgerItem(key, {\n      timeInserted: now,\n      removalDate: now + millisecondsToRemoval,\n      blobId: key\n    });\n\n    IDB.addBlobItem(key, blob);\n  },\n\n  /**\n   * remove a cached item from indexeddb\n   *\n   * @param {String} key - a unique identifier for this blob\n   */\n  remove (key) {\n    IDB.removeBlobItem(key);\n    IDB.removeLedgerItem(key);\n  },\n\n  /**\n   * update a cached item\"s blob / redirects to Cache.set\n   *\n   * @param {String} key - a unique identifier for this blob\n   * @param {Blob} blob - the blob of data to be inserted\n   * @param {Integer} minutes_to_removal - time until removal from cache\n   */\n  update (key, blob, minutes_to_removal) {\n    return this.set.apply(this, arguments);\n  },\n\n  /**\n   * retrieve an item from the cache\n   *\n   * @param {String} key - a unique identifier for this blob\n   */\n  get (key) {\n    var promise = IDB.getBlobItem(key);\n\n    return promise;\n  },\n\n  __error (err) {\n\n  },\n};\n\n/* -------------------------------------------------------------------------- */\n\nIDB.db.then(function (db) {\n  console.log('cache init');\n});\n\n/* -------------------------------------------------------------------------- */\n\nexport default Cache;\n","import Promise from \"../lib/promise\";\n\n/* -------------------------------------------------------------------------- */\n\nwindow.indexedDB = window.indexedDB || window.webkitIndexedDB ||\n                   window.mozIndexedDB || window.OIndexedDB ||\n                   window.msIndexedDB;\n\nwindow.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction ||\n                        window.OIDBTransaction || window.msIDBTransaction;\n\nconst dbVersion = 1;\nconst request = indexedDB.open(\"indexdb_cache\", dbVersion);\n\nrequest.onsuccess = _onsuccess;\nrequest.onupgradeneeded = _onupgradeneeded;\n\n/* -------------------------------------------------------------------------- */\n\nfunction _onsuccess (event) {\n  var db = request.result;\n\n  db.onerror = _onerror;\n\n  if (db.setVersion) {\n    if (db.version != dbVersion) {\n      var setVersion = db.setVersion(dbVersion);\n\n      setVersion.onsuccess = function () {\n        _createObjectStore(db);\n      };\n    }\n  } else {\n    _initialize(db);\n  }\n}\n\nfunction _onerror (err) {\n  console.error(\"Database Error\", err, err.stack);\n}\n\nfunction _onupgradeneeded (event) {\n  _createObjectStore(event.target.result);\n}\n\nfunction _removeOldCacheItems (db) {\n  var promise = new Promise();\n  var trans = db.transaction(\"ledger\", IDBTransaction.READ_ONLY);\n  var ledgerStore = trans.objectStore(\"ledger\");\n  var itemsToBeDeleted = [];\n  var deletedItemsPromises = [];\n\n  trans.oncomplete = function () {\n    if (itemsToBeDeleted.length) {\n      itemsToBeDeleted.forEach(function (item) {\n        let ledgerPromise = IDB.removeLedgerItem(item.blobId);\n        let blobPromise = IDB.removeBlobItem(item.blobId);\n\n        deletedItemsPromises.push(ledgerPromise);\n        deletedItemsPromises.push(blobPromise);\n      });\n\n      Promise.all(deletedItemsPromises).then(function () {\n        promise.resolve();\n      });\n    } else {\n      promise.resolve();\n    }\n  };\n\n  var cursorRequest = ledgerStore.openCursor();\n\n  cursorRequest.onerror = _onerror;\n\n  cursorRequest.onsuccess = function(event) {\n    var cursor = event.target.result;\n\n    if (cursor) {\n      var element = cursor.value;\n      var removalDate = element.removalDate;\n\n      if (removalDate < Date.now()) {\n        itemsToBeDeleted.push(cursor.value);\n      }\n\n      cursor.continue();\n    }\n  };\n\n  return promise;\n}\n\nfunction _initialize (db) {\n  // sneaky set the _db without triggering promise saying were ready\n  IDB._db = db;\n\n  _removeOldCacheItems(db).then(function () {\n    IDB.db = db;\n  });\n}\n\nfunction _createObjectStore (db) {\n  let blobStore = db.createObjectStore(\"blobs\");\n  let ledgerStore = db.createObjectStore(\"ledger\");\n}\n\n/* -------------------------------------------------------------------------- */\n\nconst IDB = {\n  _readyPromise: new Promise(),\n\n  get db () {\n    this._readyPromise = new Promise();\n\n    setTimeout(v => {\n      if (this._db) {\n        this._readyPromise.resolve(this._db);\n        this._readyPromise = null;\n      }\n    });\n\n    return this._readyPromise;\n  },\n\n  set db (obj) {\n    this._db = obj;\n\n    if (this._readyPromise === null) return;\n\n    this._readyPromise.resolve(this._db);\n    this._readyPromise = null;\n  },\n\n  addLedgerItem (key, params) {\n    var promise = new Promise();\n    var transaction = this._db.transaction([\"ledger\"],\n        \"readwrite\");\n\n    var objectStore = transaction.objectStore(\"ledger\");\n    var request = objectStore.put(params, key);\n\n    request.onsuccess = function () {\n      promise.resolve(true);\n    };\n\n    request.onerror = function (err) {\n      promise.reject(err);\n    };\n\n    return promise;\n  },\n\n  addBlobItem (key, blob) {\n    var promise = new Promise();\n    var transaction = this._db.transaction([\"blobs\"],\n        \"readwrite\");\n\n    var objectStore = transaction.objectStore(\"blobs\");\n    var request = objectStore.put(blob, key);\n\n    request.onsuccess = function () {\n      promise.resolve(true);\n    };\n\n    request.onerror = function (err) {\n      promise.reject(err);\n    };\n\n    return promise;\n  },\n\n  removeLedgerItem (key) {\n    var promise = new Promise();\n    var transaction = this._db.transaction([\"ledger\"],\n        \"readwrite\");\n\n    var objectStore = transaction.objectStore(\"ledger\");\n    var request = objectStore.delete(key);\n\n    request.onsuccess = (function (promise) {\n      return function () {\n        promise.resolve(true);\n      }\n    })(promise);\n\n    request.onerror = function (err) {\n      promise.reject(err);\n    };\n\n    return promise;\n  },\n\n  removeBlobItem (key) {\n    var promise = new Promise();\n    var transaction = this._db.transaction([\"blobs\"],\n        \"readwrite\");\n\n    var objectStore = transaction.objectStore(\"blobs\");\n    var request = objectStore.delete(key);\n\n    request.onsuccess = (function (promise) {\n      return function () {\n        promise.resolve(true);\n      }\n    })(promise);\n\n    request.onerror = function (err) {\n      promise.reject(err);\n    };\n\n    return promise;\n  },\n\n  getBlobItem (key) {\n    var promise = new Promise();\n    var transaction = this._db.transaction([\"blobs\"],\n        IDBTransaction.READ);\n\n    var objectStore = transaction.objectStore(\"blobs\");\n    var request = objectStore.get(key);\n\n    request.onsuccess = function () {\n      promise.resolve(request.result);\n    };\n\n    request.onerror = function (err) {\n      promise.reject(err);\n    };\n\n    return promise;\n  },\n\n  getLedgerItem (key) {\n    var promise = new Promise();\n    var transaction = this._db.transaction([\"ledger\"],\n        IDBTransaction.READ);\n\n    var objectStore = transaction.objectStore(\"ledger\");\n    var request = objectStore.get(key);\n\n    request.onsuccess = function () {\n      promise.resolve(request.result);\n    };\n\n    request.onerror = function (err) {\n      promise.reject(err);\n    };\n\n    return promise;\n  }\n};\n\n/* -------------------------------------------------------------------------- */\n\nexport default IDB;\n"]}